---
title: 数据索引
icon: material/dice-multiple-outline
comments: true
---

???+ info "信息"

    - 默认省略导入

        - `import numpy as np`
        - `import pandas as pd`

    - 缩写

        - DataFrame缩写为"DF"
        - Series缩写为"SE"

    - 默认使用数据集: [learn_pandas.csv](https://share.ricolxwz.io/learn_pandas.csv)

        已经导入: `df = pd.read_csv('data/learn_pandas.csv', usecols=['School', 'Grade', 'Name', 'Gender', 'Weight', 'Transfer'])`

## 索引器

### DF的列索引 {#DF的列索引}

#### 单个索引

通过`[列名]`或者`.列名`可以取出单个索引对应的列, 返回值为SE. 

???+ example "例子"

    ```
    [1]: df['Name'].head()
    0      Gaopeng Yang
    1    Changqiang You
    2           Mei Sun
    3      Xiaojuan Sun
    4       Gaojuan You
    Name: Name, dtype: object
    [2]: df.Name.head()
    0      Gaopeng Yang
    1    Changqiang You
    2           Mei Sun
    3      Xiaojuan Sun
    4       Gaojuan You
    Name: Name, dtype: object
    ```

##### 多个索引

通过`[列名组成的列表]`可以取出多个索引对应的列, 返回值为DF.

???+ example "例子"

    ```
    [1]: df[['Gender', 'Name']].head()
    x	Gender	Name
    0	Female	Gaopeng Yang
    1	Male	Changqiang You
    2	Male	Mei Sun
    3	Female	Xiaojuan Sun
    4	Male	Gaojuan You
    ```

### SE的行索引

???+ info "信息"

    已经生成:

    `s = pd.Series([1, 2, 3, 4, 5, 6], index=['a', 'b', 'a', 'a', 'a', 'c'])`

#### 以字符串为索引的SE

##### 单个索引

通过`[item]`可以取出单个索引对应的元素.

- 如果SE中只有单个值和该索引对应, 则返回这个标量值
- 如果SE中有多个值和该索引对应, 则返回一个SE

???+ example "例子"

    ```
    [1]: s['a']
    a    1
    a    3
    a    4
    a    5
    dtype: int64
    [2]: s['b']
    2
    ```

##### 多个索引 

通过`[item的列表]`可以取出多个索引对应的元素.

???+ example "例子"

    ```
    [1]: s[['c', 'b']]
    c    6
    b    2
    dtype: int64
    ```

###### 两个索引之间的元素 {#取出两个索引之间的元素}

可以使用切片. 

???+ warning "注意"

    - 这里的切片与NumPy的[切片](/NumPy/数组索引/#切片索引)有一点不同, 会包含两个端点
    - 实际上, 也不算是真正意义上的切片, 这个切片中的索引是基于{==元素==}的, 而不是基于{==位置==}的
    - 这两个索引在整个索引中必须唯一

        ???+ tip "Tip"

            如果这两个索引的值在整个索引中存在重复, 那么需要经过排序才能使用切片.

            ???+ example "例子"

                ```
                [1]: try:
                        s['a': 'b']
                     except Exception as e:
                        Err_Msg = e
                [2]: Err_Msg
                KeyError("Cannot get left slice bound for non-unique label: 'a'")
                [3]: s.sort_index()['a':'b']
                a    1
                a    3
                a    4
                a    5
                b    2
                dtype: int64
                ```

???+ example "例子"

    ```
    [1]: s['c': 'b': -2]
    c    6
    a    4
    b    2
    dtype: int64
    ```

#### 以整数为索引的SE

在使用读入函数的时候, 如果不特别使用`index_col`参数指定对应的列作为索引, 那么会生成从0开始的整数索引作为默认索引. 当然, 任意一组符合长度要求的整数都可以作为索引.

和字符串一样, 如果使用`[int]`或`[int_list]`, 可以取出对应索引{==元素==}的值.

???+ example "例子"

    ```
    [1]: s[1]
    1    a
    1    c
    dtype: object
    [2]: s[[2, 3]]
    2    d
    3    b
    dtype: object
    ```

???+ warning "注意"

    - 这里的切片与NumPy的[切片](/NumPy/数组索引/#切片索引)相同
    - 这里的切片中整数的含义是索引的{==位置==}, 而不是索引本身

        ???+ example "例子"

            如索引`1, 3, 1, 2, 5, 4`, 各个索引的位置分别为`0, 1, 2, 3, 4, 5`.

            ```
            [1]: s[1:-1:2]
            3    b
            2    d
            dtype: object
            ```

### `loc`/`iloc`索引器

对于DF而言, 不仅能根据[列进行索引](#DF的列索引), 还能根据行进行索引. `loc`索引器和`iloc`索引器是一种对于DF索引来说更加普适的方法, 它既能行索引, 又能列索引.

- `loc`索引器: 基于{==元素==}的索引器
- `iloc`索引器: 基于{==位置==}的索引器 

???+ tip "Tip"

    对于SE来说, 也可以使用`loc`和`iloc`索引器.

#### `loc`索引器

`loc`索引器的一般形式是`loc[*, *]`, 其中第一个`*`代表行的选择, 第二个`*`代表列的选择. 如果省略第二个位置写作`loc[*]`, 这个`*`指行的筛选. 

其中`*`的位置一共有五类合法对象, 分别是:

- 单个元素
- 元素列表
- 元素切片
- 布尔列表
- 函数

下面将依次说明.

???+ info "信息"

    为了演示相应操作, 先利用`set_index`函数将`Name`列设为索引

    `df_demo = df.set_index('Name')`

##### `*`为单个元素

直接取出相应的行或列, 如果该元素在索引中重复则结果为DF, 否则为SE.

???+ example "例子"

    ```
    [1]: df_demo.loc['Qian Sun'] # 多个人叫此名字
                                      School      Grade  Gender  Weight Transfer
    Name                                                                        
    Qiang Sun            Tsinghua University     Junior  Female    53.0        N
    Qiang Sun            Tsinghua University  Sophomore  Female    40.0        N
    Qiang Sun  Shanghai Jiao Tong University     Junior  Female     NaN        N
    [2]: df_demo.loc['Quan Zhao'] # 此名字唯一
    School      Shanghai Jiao Tong University
    Grade                              Junior
    Gender                             Female
    Weight                               53.0
    Transfer                                N
    Name: Quan Zhao, dtype: object
    ```

也可以同时选择行与列.

???+ example "例子"

    ```
    [1]: df_demo.loc['Qian Sun', 'School'] # 返回SE
    Name
    Qiang Sun              Tsinghua University
    Qiang Sun              Tsinghua University
    Qiang Sun    Shanghai Jiao Tong University
    Name: School, dtype: object
    [2]: df_demo.loc['Quan Zhao', 'School'] # 返回单个元素
    'Shanghai Jiao Tong University'
    ```

##### `*`为元素列表

取出列表中所有元素值对应的行或列.

???+ example "例子"

    ```
    [1]: df_demo.loc[['Qiang Sun', 'Quan Zhao'], ['School', 'Gender']]
                                      School  Gender
    Name                                            
    Qiang Sun            Tsinghua University  Female
    Qiang Sun            Tsinghua University  Female
    Qiang Sun  Shanghai Jiao Tong University  Female
    Quan Zhao  Shanghai Jiao Tong University  Female
    ```

##### `*`为切片

参考[这里](#取出两个索引之间的元素), 这不是真正意义上的切片, 这个切片是基于{==元素==}的. 

???+ warning "注意"

    - 要求起始元素和终止元素是唯一的, 如果不唯一会报错.
    - 这里的切片会包含两个端点

???+ example "例子"

    ```
    [1]: df_demo.loc['Gaojuan You':'Gaoqiang Qian', 'School':'Gender']
                                          School      Grade  Gender
    Name                                                           
    Gaojuan You                 Fudan University  Sophomore    Male
    Xiaoli Qian              Tsinghua University   Freshman  Female
    Qiang Chu      Shanghai Jiao Tong University   Freshman  Female
    Gaoqiang Qian            Tsinghua University     Junior  Female
    ```

##### `*`为布尔列表  {#为布尔列表}

在实际的数据处理中, 根据条件筛选行是极其常见的, 此处传入`loc`的布尔列表与DF长度相同, 且列表为`True`的位置所对应的行会被选中, `False`则会被剔除.

???+ example "例子"

    ```
    [1]: df_demo.loc[df_demo.Weight>70].head()
                                          School      Grade Gender  Weight Transfer
    Name                                                                           
    Mei Sun        Shanghai Jiao Tong University     Senior   Male    89.0        N
    Gaojuan You                 Fudan University  Sophomore   Male    74.0        N
    Xiaopeng Zhou  Shanghai Jiao Tong University   Freshman   Male    74.0        N
    Xiaofeng Sun             Tsinghua University     Senior   Male    71.0        N
    Qiang Zheng    Shanghai Jiao Tong University     Senior   Male    87.0  
    ```

也可以用过`isin`函数返回的布尔列表等价列出.

???+ example "例子"

    ```
    [1]: df_demo.loc[df_demo.Grade.isin(['Freshman', 'Senior'])].head()
                                          School     Grade  Gender  Weight Transfer
    Name                                                                            
    Gaopeng Yang    Shanghai Jiao Tong University  Freshman  Female    46.0        N
    Changqiang You              Peking University  Freshman    Male    70.0        N
    Mei Sun         Shanghai Jiao Tong University    Senior    Male    89.0        N
    Xiaoli Qian               Tsinghua University  Freshman  Female    51.0        N
    Qiang Chu       Shanghai Jiao Tong University  Freshman  Female    52.0        N
    ```

对于复合条件, 可以用`|`(或), `&`(且), `~`(取反)的组合来实现.

???+ example "例子"

    ```
    [1]: condition_1_1 = df_demo.school == 'Fudan University'
    [2]: condition_1_2 = df_demo.Grade == 'Senior'
    [3]: condition_1_3 = df_demo.Weight > 70
    [4]: condition_1 = condition_1_1 & condition_1_2 & condition_1_3
    [5]: condition_2_1 = df_demo.School == 'Peking University'
    [6]: condition_2_2 = df_demo.Grade == 'Senior'
    [7]: condition_2_3 = df_demo.Weight > 80
    [8]: condition_2 = condition_2_1 & (~condition_2_2) & condition_2_3
    [9]: df_demo.loc[condition_1 | condition_2]
                               School     Grade Gender  Weight Transfer
    Name                                                               
    Qiang Han       Peking University  Freshman   Male    87.0        N
    Chengpeng Zhou   Fudan University    Senior   Male    81.0        N
    Changpeng Zhao  Peking University  Freshman   Male    83.0        N
    Chengpeng Qian   Fudan University    Senior   Male    73.0        Y
    ```

##### `*`为函数

???+ note "笔记"

    - 这里的函数, 必须以前面的四种合法形式之一为返回值
    - 函数的输入值为DF本身

???+ example "例子"

    ```
    [1]: def condition(x):
            condition_1_1 = x.School == 'Fudan University'
            condition_1_2 = x.Grade == 'Senior'
            condition_1_3 = x.Weight > 70
            condition_1 = condition_1_1 & condition_1_2 & condition_1_3
            condition_2_1 = x.School == 'Peking University'
            condition_2_2 = x.Grade == 'Senior'
            condition_2_3 = x.Weight > 80
            condition_2 = condition_2_1 & (~condition_2_2) & condition_2_3
            result = condition_1 | condition_2
            return result
    [2]: df_demo.loc[condition]
                               School     Grade Gender  Weight Transfer
    Name                                                               
    Qiang Han       Peking University  Freshman   Male    87.0        N
    Chengpeng Zhou   Fudan University    Senior   Male    81.0        N
    Changpeng Zhao  Peking University  Freshman   Male    83.0        N
    Chengpeng Qian   Fudan University    Senior   Male    73.0        Y
    ```

???+ tip "Tip"

    支持使用Lambda表达式, 返回值同样必须是先前提到的四种形式之一.

    ???+ example "例子"

        === "例子1"

            ```
            [1]: df_demo.loc[lambda x:'Quan Zhao', lambda x:'Gender']
            'Female'
            ```

        === "例子2"

            由于函数无法返回`<start>:<end>:<step>`的切片形式, 所以返回切片时要用slice对象进行包装.

            ```
            [1]: df_demo.loc[lambda x:slice('Gaojuan You', 'Gaoqiang Qian')]
                                                  School      Grade  Gender  Weight Transfer
            Name                                                                            
            Gaojuan You                 Fudan University  Sophomore    Male    74.0        N
            Xiaoli Qian              Tsinghua University   Freshman  Female    51.0        N
            Qiang Chu      Shanghai Jiao Tong University   Freshman  Female    52.0        N
            Gaoqiang Qian            Tsinghua University     Junior  Female    50.0        N
            ```

#### `iloc`索引器

`iloc`的使用和`loc`完全类似, 只不过是针对{==位置==}进行筛选, 在相应的`*`位置处一共也有五类合法对象. 

???+ example "例子"

    ```
    [1]: df_demo.iloc[1, 1] # 第二行第二列
    'Freshman'
    [2]: df_demo.iloc[[0, 1], [0, 1]] # 前两行前两列
                                           School     Grade
    Name                                                   
    Gaopeng Yang    Shanghai Jiao Tong University  Freshman
    Changqiang You              Peking University  Freshman
    [3]: df_demo.iloc[1: 4, 2:4] # 切片不包含结束端点, 这里的切片是真正的切片
                    Gender  Weight
    Name                          
    Changqiang You    Male    70.0
    Mei Sun           Male    89.0
    Xiaojuan Sun    Female    41.0
    [4]: df_demo.iloc[lambda x: slice(1, 4)] # 传入切片为返回值的函数
                                           School      Grade  Gender  Weight Transfer
    Name                                                                             
    Changqiang You              Peking University   Freshman    Male    70.0        N
    Mei Sun         Shanghai Jiao Tong University     Senior    Male    89.0        N
    Xiaojuan Sun                 Fudan University  Sophomore  Female    41.0        N
    ```

???+ warning "注意"

    在使用布尔列表的时候要特别注意, 不能传入SE而必须传入序列的`values`, 否则会报错. `values`的作用是取出SE的值, 即一个NumPy数组.

    ???+ example "例子"

        ```
        [1]: df_demo.iloc[(df_demo.Weight>80).values].head()
                                               School      Grade Gender  Weight Transfer
        Name                                                                            
        Mei Sun         Shanghai Jiao Tong University     Senior   Male    89.0        N
        Qiang Zheng     Shanghai Jiao Tong University     Senior   Male    87.0        N
        Qiang Han                   Peking University   Freshman   Male    87.0        N
        Chengpeng Zhou               Fudan University     Senior   Male    81.0        N
        Feng Han        Shanghai Jiao Tong University  Sophomore   Male    82.0        N
        ```

### `query`函数 

在Pandas中, 支持把字符串形式的查询表达式传入`query`函数来查询数据, 其表达式的执行结果必须返回布尔列表. 

在进行复杂索引的时候, 由于这种检索方式无需像[普通方法](#为布尔列表)一样重复使用DF的名字来引用列名. 一般而言会使代码长度在不降低可读性的前提下有所减少.

???+ example "例子"

    例如, 在`loc`索引器一节的[复合条件查询例子](#为布尔列表)可以如下改写: 

    ```
    [1]: df.query('((School == "Fudan University")&'
                  ' (Grade == "Senior")&'
                  ' (Weight > 70))|'
                  '((School == "Peking University")&'
                  ' (Grade != "Senior")&'
                  ' (Weight > 80))')
                    School     Grade            Name Gender  Weight Transfer
    38   Peking University  Freshman       Qiang Han   Male    87.0        N
    66    Fudan University    Senior  Chengpeng Zhou   Male    81.0        N
    99   Peking University  Freshman  Changpeng Zhao   Male    83.0        N
    131   Fudan University    Senior  Chengpeng Qian   Male    73.0        Y
    ```

???+ note "笔记"

    - 在`query`表达式中, 帮用户注册了所有来自DF的列名, 所有属于该列/SE的方法都可以被调用, 和正常的函数调用并没有区别

        ???+ example "例子"

            ```
            [1]: df.query('Weight > Weight.mena()').head()
                                    School      Grade            Name  Gender  Weight Transfer
            1               Peking University   Freshman  Changqiang You    Male    70.0        N
            2   Shanghai Jiao Tong University     Senior         Mei Sun    Male    89.0        N
            4                Fudan University  Sophomore     Gaojuan You    Male    74.0        N
            10  Shanghai Jiao Tong University   Freshman   Xiaopeng Zhou    Male    74.0        N
            14            Tsinghua University     Senior    Xiaomei Zhou  Female    57.0        N
            ```

    - 在`query`表达式中, 还注册了若干英语的字面用法, 帮助提高可读性. 如`or, and, or, in, not in`

        ???+ example "例子"

            ```
            [1]: df.query('(Grade not in ["Freshman", "Sophomore"]) and (Gender == "Male")').head()
                                       School   Grade           Name Gender  Weight Transfer
            2   Shanghai Jiao Tong University  Senior        Mei Sun   Male    89.0        N
            16            Tsinghua University  Junior  Xiaoqiang Qin   Male    68.0        N
            17            Tsinghua University  Junior      Peng Wang   Male    65.0        N
            18            Tsinghua University  Senior   Xiaofeng Sun   Male    71.0        N
            21  Shanghai Jiao Tong University  Senior  Xiaopeng Shen   Male    62.0      NaN
            ```

    - `==`和`!=`分别等价于`in`和`not in`

        ???+ example "例子"

            ```
            [1]: df.query('Grade == ["Junior", "Senior"]').head()
                                       School   Grade           Name  Gender  Weight Transfer
            2   Shanghai Jiao Tong University  Senior        Mei Sun    Male    89.0        N
            7             Tsinghua University  Junior  Gaoqiang Qian  Female    50.0        N
            9               Peking University  Junior        Juan Xu  Female     NaN        N
            11            Tsinghua University  Junior    Xiaoquan Lv  Female    43.0        N
            12  Shanghai Jiao Tong University  Senior       Peng You  Female    48.0      NaN
            ```

???+ tip "Tip"

    - 对于含有空格的列名, 需要使用`col name`的方式进行引用
    - 若要引用外部变量, 只需要在变量名前面加`@`

        ???+ example "例子"

            ```
            [1]: low, high =70, 80
            [2]: df.query('(Weight >= @low) & (Weight <= @high)').head()
                                       School      Grade            Name Gender  Weight Transfer
            1               Peking University   Freshman  Changqiang You   Male    70.0        N
            4                Fudan University  Sophomore     Gaojuan You   Male    74.0        N
            10  Shanghai Jiao Tong University   Freshman   Xiaopeng Zhou   Male    74.0        N
            18            Tsinghua University     Senior    Xiaofeng Sun   Male    71.0        N
            35              Peking University   Freshman      Gaoli Zhao   Male    78.0        N
            ```

### 随机抽样

如果把DF的每一行看做一个样本, 或者把每一列看做一个特征, 再把整个DF看作总体, 想要对样本或者特征进行随机抽样就可以用`sample`函数. 有时候在拿到大型数据集后, 想要对统计特征进行计算来了解数据的大致分布, 但是这很费事件. 同时, 由于许多统计特征在等概率不放回的简单随机抽样条件下, 是总体统计特征的无偏估计(例如在多次抽样后, 所有抽样均值的期望等于所有元素的均值).

`sample`函数的主要参数为`<n>, <axis>, <frac>, <replace>, <weights>`, 前三个指的是抽样数量, 抽样方向(0为行, 1为列)和抽样比例(0.3为从总体中抽出30%的样本); `<replace>`和`<weights>`分别是指是否放回和每个样本的抽样相对概率, 当`replace=True`表示有放回抽样. 

???+ example "例子"

    下面构造的`df_sample`以`value`值的大小为抽样概率进行有放回的抽样, 抽样数量为3.

    ```
    [1]: df_sample = pd.DataFrame({'id': list('abcde'), 'value': [1, 2, 3, 4, 90]})
    [2]: df_sample
      id  value
    0  a      1
    1  b      2
    2  c      3
    3  d      4
    4  e     90
    [3]: df_sample.sample(3, replace=True, weights=df_sample.value)
      id  value
    4  e     90
    4  e     90
    4  e     90
    ```

[^1]: 第三章 索引—Joyful Pandas 1.0 documentation. (n.d.). Retrieved June 29, 2024, from https://inter.joyfulpandas.datawhale.club/Content/ch3.html